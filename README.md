# Preciouss

è·¨å¹³å°ä¸ªäººè®°è´¦ç³»ç»Ÿï¼ŒåŸºäº Beancount v3 ç”Ÿæ€ï¼Œç®¡ç†ä¸­å›½å¤§é™†å’Œé¦™æ¸¯çš„å¤šä¸ªé“¶è¡Œã€æ”¯ä»˜å¹³å°å’Œåˆ¸å•†è´¦æˆ·ã€‚

## è§£å†³çš„é—®é¢˜

- è´¦å•åˆ†æ•£åœ¨åå‡ ä¸ªå¹³å°ï¼Œæ— æ³•ç»Ÿä¸€æŸ¥çœ‹
- è·¨å¹³å°äº¤æ˜“ï¼ˆå¦‚æ”¯ä»˜å®åˆ·ä¿¡ç”¨å¡ï¼‰äº§ç”Ÿé‡å¤è®°å½•éœ€è¦åŒ¹é…
- æ‰‹åŠ¨åˆ†ç±»è€—æ—¶ï¼Œéœ€è¦æ™ºèƒ½åˆ†ç±»è¾…åŠ©

## æ”¯æŒçš„å¹³å°

| å¹³å° | ç±»å‹ | çŠ¶æ€ |
|------|------|------|
| æ”¯ä»˜å® | CSV å¯¼å…¥ | âœ… |
| æ‹›å•†é“¶è¡Œ (ä¿¡ç”¨å¡/å‚¨è“„å¡) | CSV å¯¼å…¥ | âœ… |
| å¾®ä¿¡æ”¯ä»˜ | CSV/XLSX å¯¼å…¥ | âœ… |
| å¾®ä¿¡æ”¯ä»˜é¦™æ¸¯ (WeChat Pay HK) | JSON å¯¼å…¥ | âœ… |
| äº¬ä¸œ | CSV å¯¼å…¥ | âœ… |
| ALDI å¥¥ä¹é½ | JSON å¯¼å…¥ | âœ… |
| Costco å¼€å¸‚å®¢ | JSON å¯¼å…¥ | âœ… |
| å·¥å•†é“¶è¡Œ | CSV/PDF å¯¼å…¥ | ğŸ”œ |
| å»ºè®¾é“¶è¡Œ | CSV/PDF å¯¼å…¥ | ğŸ”œ |
| ä¸­å›½é“¶è¡Œ | CSV å¯¼å…¥ | ğŸ”œ |
| æ±‡ä¸°é¦™æ¸¯ | CSV å¯¼å…¥ | ğŸ”œ |
| ä¸­é“¶é¦™æ¸¯ | CSV/PDF å¯¼å…¥ | ğŸ”œ |
| AlipayHK | CSV å¯¼å…¥ | ğŸ”œ |
| äº‘é—ªä»˜ | CSV å¯¼å…¥ | ğŸ”œ |
| Interactive Brokers | Flex Query API | ğŸ”œ |
| PayPal | REST API | ğŸ”œ |

## å®‰è£…

### å‰ç½®è¦æ±‚

- [mise](https://mise.jdx.dev/) - ç‰ˆæœ¬ç®¡ç†å·¥å…·

### å®‰è£…æ­¥éª¤

```bash
# å…‹éš†é¡¹ç›®
git clone <repo-url> preciouss
cd preciouss

# å®‰è£… Python å’Œ uv (é€šè¿‡ mise)
mise install

# å®‰è£…ä¾èµ–
uv sync

# éªŒè¯å®‰è£…
uv run preciouss --version
```

## å¿«é€Ÿå¼€å§‹

```bash
# 1. åˆå§‹åŒ–è´¦æœ¬ç›®å½•
uv run preciouss init

# 2. å¯¼å…¥è´¦å•æ–‡ä»¶ï¼ˆè‡ªåŠ¨è¯†åˆ«å¹³å°ï¼‰
uv run preciouss import ~/Downloads/alipay_202401.csv ~/Downloads/cmb_202401.csv

# 3. æŸ¥çœ‹å¯¼å…¥çŠ¶æ€
uv run preciouss status

# 4. å¯åŠ¨ Fava Web UI æŸ¥çœ‹å’Œç¼–è¾‘
uv run preciouss fava
```

## CLI å‘½ä»¤

```
preciouss init                          # åˆå§‹åŒ–è´¦æœ¬ç›®å½•å’Œé»˜è®¤æ–‡ä»¶
preciouss import <file>...              # å¯¼å…¥è´¦å•æ–‡ä»¶ï¼ˆè‡ªåŠ¨è¯†åˆ«å¹³å°ï¼‰
preciouss import --source alipay        # æŒ‡å®šå¹³å°å¯¼å…¥
preciouss import --year 2024:2025       # åªå¯¼å…¥ 2024 å¹´çš„äº¤æ˜“
preciouss import --year 2020:2026       # åªå¯¼å…¥ 2020â€“2025 å¹´çš„äº¤æ˜“
preciouss match                         # è¿è¡Œè·¨å¹³å°äº¤æ˜“åŒ¹é…
preciouss categorize                    # è¿è¡Œæ™ºèƒ½åˆ†ç±»
preciouss status                        # æŸ¥çœ‹å¯¼å…¥çŠ¶æ€å’Œç»Ÿè®¡
preciouss fava                          # å¯åŠ¨ Fava Web UI
```

### `--year` æ—¥æœŸèŒƒå›´è¿‡æ»¤

å½“è´¦å•æ–‡ä»¶è·¨å¤šå¹´ï¼Œä½†åªéœ€å¯¼å…¥ç‰¹å®šå¹´ä»½æ—¶ä½¿ç”¨ï¼š

```bash
# åªå¯¼å…¥ 2024 å¹´ï¼ˆ2024-01-01 åˆ° 2024-12-31ï¼‰
preciouss import --year 2024:2025 alipay_all.csv

# å¯¼å…¥ 2020â€“2025 å¹´ï¼ˆ2026-01-01 ä¹‹å‰çš„æ‰€æœ‰äº¤æ˜“ï¼‰
preciouss import --year 2020:2026 alipay_all.csv
```

è¯­ä¹‰ï¼š`--year START:END` ä¿ç•™æ»¡è¶³ `START-01-01 â‰¤ äº¤æ˜“æ—¥æœŸ < END-01-01` çš„äº¤æ˜“ï¼Œå³åŒ…å« START å¹´ã€ä¸åŒ…å« END å¹´ã€‚

## åˆ†ç±»è§„åˆ™

å†…ç½®è§„åˆ™è¦†ç›–å¸¸è§å•†æˆ·ã€å“ç‰Œå’Œäº¤æ˜“ç±»å‹ï¼Œè‡ªåŠ¨æ˜ å°„åˆ° Beancount è´¦æˆ·ã€‚éƒ¨åˆ†è§„åˆ™æ„ŸçŸ¥æ”¶æ”¯æ–¹å‘ï¼š

| äº¤æ˜“æè¿° | æ”¯å‡º (expense) | æ”¶å…¥ (income) |
|----------|---------------|--------------|
| è½¬è´¦ | `Expenses:Transfer` | `Income:Transfer` |
| ç¾¤æ”¶æ¬¾ | `Expenses:Transfer` | `Income:Transfer` |
| å·¥èµ„/è–ªèµ„ | â€” | `Income:Salary` |
| é€€æ¬¾/é€€è´§ | â€” | `Income:Refund` |

å¯åœ¨ `config.toml` ä¸­é€šè¿‡ `[categorize.keyword_rules]` æ·»åŠ è‡ªå®šä¹‰å…³é”®è¯è§„åˆ™ï¼ˆä¼˜å…ˆçº§é«˜äºå†…ç½®è§„åˆ™ï¼‰ã€‚

## é…ç½®

å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶å¹¶ä¿®æ”¹ï¼š

```bash
cp config.example.toml config.toml
```

é…ç½®æ–‡ä»¶æ”¯æŒï¼š
- è´¦æˆ·å®šä¹‰ï¼ˆé“¶è¡Œã€æ”¯ä»˜å¹³å°ã€åˆ¸å•†ï¼‰
- åŒ¹é…å¼•æ“å‚æ•°ï¼ˆæ—¥æœŸå®¹å·®ã€ç›¸ä¼¼åº¦é˜ˆå€¼ï¼‰
- è‡ªå®šä¹‰åˆ†ç±»è§„åˆ™ï¼ˆå…³é”®è¯ â†’ åˆ†ç±»æ˜ å°„ï¼‰

è¯¦è§ `config.example.toml` ä¸­çš„æ³¨é‡Šã€‚

## æ•°æ®æµ

```
CSV/JSON/XLSX
    â”‚
    â–¼
Importer (è§£æä¸ºä¸­é—´ Transaction æ ¼å¼)
    â”‚  æ¯ç¬”äº¤æ˜“ç‹¬ç«‹å¯¼å…¥ï¼›è·¨å¹³å°é‡å¤ä¸åˆå¹¶ï¼Œè€Œæ˜¯é€šè¿‡æ¸…ç®—è´¦æˆ·æ¡¥æ¥
    â–¼
Clearing Engine (DFS æ¸…ç®—é“¾åŒ¹é…)
    â”‚  ä»"ç»ˆç«¯æ”¯å‡º"å‘ä¸Šè¿½æº¯æ¸…ç®—è´¦æˆ·é“¾ï¼Œåˆ†é…å…±äº« ^clr-NNNNNN é“¾æ¥æ ‡ç­¾
    â”‚  ç»ˆç«¯æ”¯å‡º = source_account æ˜¯æ¸…ç®—è´¦æˆ· + counter_account æ˜¯æ¶ˆè´¹è´¦æˆ·
    â–¼
Categorizer (è§„åˆ™åˆ†ç±»)
    â”‚  å…³é”®è¯/æ­£åˆ™ â†’ Beancount è´¦æˆ·ï¼›æ„ŸçŸ¥æ”¶æ”¯æ–¹å‘
    â–¼
Ledger Writer (å†™å…¥ .bean æ–‡ä»¶)
    â”‚  æ™®é€šäº¤æ˜“ / å¤š postingï¼ˆALDI/Costco/JDï¼‰ / è·¨å¸ç§æ¡¥æ¥ï¼ˆWeChatHKï¼‰
    â–¼
Fava (å¯è§†åŒ– + ç¼–è¾‘)
```

### æ¸…ç®—è´¦æˆ·è®¾è®¡

è·¨å¹³å°äº¤æ˜“ä¸åšè¿è¡Œæ—¶åˆå¹¶ï¼Œè€Œæ˜¯é€šè¿‡ `Assets:Clearing:*` è´¦æˆ·è‡ªç„¶å¯¹å†²ï¼š

```
å¾®ä¿¡æ”¯ä»˜  â†’  Assets:Clearing:JD:WX        â†  äº¬ä¸œæ”¶æ¬¾
ALDI æ”¶æ® â†  Assets:Clearing:ALDI         â†  å¾®ä¿¡/æ”¯ä»˜å®ä»˜æ¬¾
WechatHK  â†’  Assets:Clearing:Costco (HKD) â†  Costco æ”¶æ® (CNY, @ rate)
```

`preciouss import` æ—¶è‡ªåŠ¨è¿è¡Œ DFS æ¸…ç®—é“¾åŒ¹é…ï¼Œå°†ç›¸å…³äº¤æ˜“ç”¨ `^clr-NNNNNN` é“¾æ¥æ ‡ç­¾å…³è”ï¼Œä¾¿äºåœ¨ Fava ä¸­æŸ¥çœ‹å®Œæ•´é“¾è·¯ã€‚

## å¼€å‘

```bash
# è¿è¡Œæµ‹è¯•
uv run pytest tests/ -v

# ä»£ç æ£€æŸ¥
uv run ruff check src/

# ç±»å‹æ£€æŸ¥
uv run mypy src/preciouss/
```

## License

MIT
